<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- ModelTrackingMapper.xml -->
<mapper namespace="com.example.demo.mappers.ModelTrackingMapper">
	
	<resultMap type="com.example.demo.entity.ModelTracking" id="modelTrackingResultMap">
		<result property="mtId" column="mt_id" />
		<result property="mtFkContractId" column="mt_fk_contract_id" />
		<result property="mtFkMessageModelId" column="mt_fk_message_model_id" />
		<result property="mtFkStatusId" column="mt_fk_status_id" />
		<result property="mtFkCategoryId" column="mt_fk_category_id" />
		<result property="mtSendDate" column="mt_send_date" />
		<result property="mtValidationDate" column="mt_validation_date" />
        <association property="messageModel" javaType="com.example.demo.entity.MessageModel">
            <id property="mmId" column="mm_id"/>
            <result property="mmSubject" column="mm_subject"/>
        </association>
        <association property="contract" javaType="com.example.demo.entity.Contract">
            <id property="cId" column="c_id"/>
            <result property="cFKserviceProviderId" column="c_fk_service_provider_id"/>
<!--            <result property="cFkSubcontractorId" column="c_fk_subcontractor_id"/>-->
        </association>
	</resultMap>

    <insert id="insertGstModelTracking" statementType="PREPARED" useGeneratedKeys="true" keyProperty="mtId" keyColumn="mt_id" parameterType="com.example.demo.entity.ModelTracking">
        INSERT INTO schema_dev.gst_model_tracking (
            mt_send_date, mt_validation_date, mt_fk_contract_id, mt_fk_message_model_id, mt_fk_status_id, mt_fk_category_id
        )
        VALUES (
            #{mtSendDate}, #{mtValidationDate}, #{mtFkContractId}, #{mtFkMessageModelId}, #{mtFkStatusId}, #{mtFkCategoryId}
        )
    </insert>

    <update id="updateModelTracking" >
        UPDATE schema_dev.gst_model_tracking
        SET mt_send_date = #{mtSendDate},
            mt_validation_date = #{mtValidationDate},
            mt_fk_contract_id = #{mtFkContractId},
            mt_fk_message_model_id = #{mtFkMessageModelId},
            mt_fk_status_id = #{mtFkStatusId},
            mt_fk_category_id = #{mtFkCategoryId}
        WHERE mt_fk_contract_id = #{mtFkContractId}
          AND mt_fk_message_model_id = #{mtFkMessageModelId}
    </update>

    <select id="findAllModelTrackingInfo" resultType="com.example.demo.dto.ModelTrackingDTO">
        SELECT
            mt.mt_id AS mtId,
            mt.mt_send_date AS mtSendDate,
            mt.mt_validation_date AS mtValidationDate,
            mt.mt_fk_contract_id AS mtFkContractId,
            mt.mt_fk_message_model_id AS mtFkMessageModelId,
            mt.mt_fk_status_id AS mtFkStatusId,
            mt.mt_fk_category_id AS mtFkCategoryId
        FROM schema_dev.gst_model_tracking mt
    </select>

    <select id="getModelTrackingInfoByContractId" resultType="com.example.demo.dto.ModelTrackingDTO" parameterType="int">
        SELECT
            mt.mt_id AS mtId,
            mt.mt_send_date AS mtSendDate,
            mt.mt_validation_date AS mtValidationDate,
            mt.mt_fk_contract_id AS mtFkContractId,
            mt.mt_fk_message_model_id AS mtFkMessageModelId,
            mt.mt_fk_status_id AS mtFkStatusId,
            mt.mt_fk_category_id AS mtFkCategoryId
        FROM schema_dev.gst_model_tracking mt
        WHERE mt.mt_fk_contract_id = #{contractId}
    </select>
    
    <select id="getAllMessageModelByServiceProviderId" resultMap="modelTrackingResultMap">
        SELECT
			mt.mt_id,
			mt.mt_fk_contract_id,
			ct.c_fk_service_provider_id,
			mt.mt_fk_message_model_id,
			mm.mm_subject,
			mt.mt_fk_status_id,
			mt.mt_fk_category_id,
			mt.mt_send_date,
			mt.mt_validation_date
		FROM gst_model_tracking mt
			LEFT JOIN gst_contract ct ON mt.mt_fk_contract_id = ct.c_id
			LEFT JOIN gst_message_model mm ON mt.mt_fk_message_model_id = mm.mm_id
			LEFT JOIN gst_service_provider sp ON ct.c_fk_service_provider_id = sp.sp_id
			LEFT JOIN gst_category cy ON mt.mt_fk_category_id = cy.cat_id
		WHERE ct.c_fk_service_provider_id = #{serviceProviderId}
		AND mt.mt_fk_category_id = '1'
		ORDER BY mt.mt_id ASC;
    </select>
    
    <select id="getAllModelTrackingInfoBySubcontractorId" resultType="com.example.demo.dto.ModelTrackingDTO" parameterType="int">
		SELECT
			mt.mt_id AS mtId,
			mt.mt_fk_contract_id AS mtFkContractId,
			ct.c_fk_subcontractor_id AS ctFkSubcontractorId,
			mt.mt_fk_message_model_id AS mtFkMessageModelId,
			mm.mm_subject AS Titre,
			mt.mt_fk_status_id AS mtFkStatusId,
			mt.mt_fk_category_id AS mtFkCategoryId,
			mt.mt_send_date AS mtSendDate,
			mt.mt_validation_date AS mtValidationDate
		FROM schema_dev.gst_model_tracking mt
			LEFT JOIN schema_dev.gst_contract ct ON mt.mt_fk_contract_id = ct.c_id
			LEFT JOIN schema_dev.gst_message_model mm ON mt.mt_fk_message_model_id = mm.mm_id
			LEFT JOIN schema_dev.gst_subcontractor sc ON ct.c_fk_subcontractor_id = sc.s_id
			LEFT JOIN schema_dev.gst_category cy ON mt.mt_fk_category_id = cy.cat_id
		WHERE ct.c_fk_subcontractor_id = #{subcontractorId}
		AND mt.mt_fk_category_id != '1'
		ORDER BY mt.mt_id ASC;
    </select>

    <select id="findModelTrackingInfoByMmId" resultType="com.example.demo.dto.ModelTrackingDTO" parameterType="int">
        SELECT
            mt.mt_id AS mtId,
            mt.mt_send_date AS mtSendDate,
            mt.mt_validation_date AS mtValidationDate,
            mt.mt_fk_contract_id AS mtFkContractId,
            mt.mt_fk_message_model_id AS mtFkMessageModelId,
            mt.mt_fk_status_id AS mtFkStatusId,
            mt.mt_fk_category_id AS mtFkCategoryId
        FROM schema_dev.gst_model_tracking mt
        WHERE mt.mt_fk_message_model_id = #{mmId}
    </select>

    <select id="findModelTrackingInfoByContractIdAndMmId" resultType="com.example.demo.dto.ModelTrackingDTO" parameterType="int">
        SELECT
            mt.mt_id AS mtId,
            mt.mt_send_date AS mtSendDate,
            mt.mt_validation_date AS mtValidationDate,
            mt.mt_fk_contract_id AS mtFkContractId,
            mt.mt_fk_message_model_id AS mtFkMessageModelId,
            mt.mt_fk_status_id AS mtFkStatusId,
            mt.mt_fk_category_id AS mtFkCategoryId
        FROM schema_dev.gst_model_tracking mt
        WHERE mt.mt_fk_contract_id = #{contractId}
          AND mt.mt_fk_message_model_id = #{mmId}
    </select>

</mapper>