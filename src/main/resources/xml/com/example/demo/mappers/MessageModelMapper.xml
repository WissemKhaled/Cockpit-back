<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mappers.MessageModelMapper">

    <resultMap id="messageModelMap" type="com.example.demo.entity.MessageModel">
        <id property="mmId" column="mm_id" />
        <result property="mmLink" column="mm_link" />
        <result property="mmHasEmail" column="mmHasEmail" />
        <result property="mmSubject" column="mm_subject" />
        <result property="mmBody" column="mm_body" />
        <result property="mmLastUpdate" column="mm_last_update" />
        <result property="mmCreationDate" column="mm_creation_date" />
        <result property="sendDate" column="send_date" />
        <result property="validationDate" column="validation_date" />
        <result property="statusId" column="statusId" />
        <result property="statusName" column="status_stName" />

        <!-- Association mapping -->
        <association property="category" javaType="com.example.demo.entity.Category">
            <result property="catId" column="mm_fk_category_id" />
            <result property="catName" column="cat_name" />
        </association>

        <!-- Assuming subcontractor and service provider are also part of the model -->
        <association property="subcontractor" javaType="com.example.demo.entity.Subcontractor">
            <result property="sId" column="s_id" />
            <result property="sName" column="s_name" />
            <result property="sEmail" column="s_email" />
            <result property="fkStatusId" column="s_fk_status_id" />
        </association>
        <association property="serviceProvider" javaType="com.example.demo.entity.ServiceProvider">
            <result property="spId" column="sp_id" />
            <result property="spName" column="sp_name" />
            <result property="spEmail" column="sp_email" />
            <result property="fkStatusId" column="sp_fk_status_id" />
        </association>

    </resultMap>

    <select id="getAllMessageModelByStatusIdOrSubContractorIdOrServiceProviderId" resultMap="messageModelMap" parameterType="map">
        SELECT DISTINCT
            gmm.mm_id,
            gmm.mm_link,
            gmm.mm_has_email AS mmHasEmail,
            gsc.s_id,
            gsc.s_name,
            gsc.s_email,
            gsc.s_fk_status_id as s_fk_status_id,
            gsp.sp_id,
            gsp.sp_name,
            gsp.sp_email,
            gsp.sp_fk_status_id as sp_fk_status_id,
            gc.cat_name AS cat_name,
            gmm.mm_fk_category_id,
            gmm.mm_link,
            gmm.mm_subject,
            gmm.mm_body,
            gmm.mm_last_update,
            gmm.mm_creation_date,
            gmt.mt_send_date AS send_date,
            gmt.mt_validation_date AS validation_date,
            st.st_id AS statusId,
            st.st_name AS status_stName
        FROM gst_model_tracking gmt
                 LEFT JOIN gst_message_model gmm ON gmm.mm_id = gmt.mt_fk_message_model_id
                 LEFT JOIN gst_category gc ON gmt.mt_fk_category_id = gc.cat_id
                 LEFT JOIN gst_status st ON gmt.mt_fk_status_id = st.st_id
                 LEFT JOIN gst_subcontractor gsc ON st.st_id = gsc.s_fk_status_id
                 LEFT JOIN gst_service_provider gsp ON st.st_id = gsp.sp_fk_status_id
        WHERE
            (gsc.s_id IS NULL OR (gsc.s_id = #{subContractorId} AND gc.cat_name = 'SC'))
           OR (gsp.sp_id IS NULL OR (gsp.sp_id = #{serviceProviderId} AND gc.cat_name = 'SP'))
           OR (s_fk_status_id IS NULL OR (s_fk_status_id = #{subContractorStatusId} AND gc.cat_name = 'SC'))
           OR (sp_fk_status_id IS NULL OR (sp_fk_status_id = #{serviceProviderStatusId} AND gc.cat_name = 'SP'))
    </select>


</mapper>
